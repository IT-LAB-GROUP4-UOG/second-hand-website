{% extends 'rangoMarket/base.html' %}

{% block body_block %}
    <h2>Order Details</h2>
    {% for image in order.item.images.all %}
        <img src="{{ image.image.url }}" alt="{{ order.item.title }}">
    {% empty %}
        <p>No images available.</p>
    {% endfor %}
    <p>Item: {{ order.item.title }}</p>
    <p>Price: ${{ order.item.price }}</p>
    <p>Status: {{ order.get_status_display }}</p>
    <p>Buyer: {{ order.buyer.username }} - Email: {{ order.buyer.email }}</p>
    <p>Seller: {{ order.seller.username }} - Email: {{ order.seller.email }}</p>


    {% if order.status == 'PENDING' %}
        <!-- finish order button -->
        <div>
            {% if order.buyer == user and not order.buyer_confirmed or order.seller == user and not order.seller_confirmed %}
                <button id="finishOrderBtn" data-order-id="{{ order.id }}" class="btn btn-primary">Finish Order</button>
                <input type="hidden" id="csrf-token" value="{{ csrf_token }}">
            {% endif %}
        </div>
        <!-- cancel order button -->
        <div>
            {% if not order.buyer_confirmed and not order.seller_confirmed %}
                {% if order.buyer == user or order.seller == user %}
                    <button id="cancelOrderBtn" data-order-id="{{ order.id }}" class="btn btn-danger">Cancel Order
                    </button>
                    <input type="hidden" id="csrf-token" value="{{ csrf_token }}">
                {% endif %}
            {% endif %}
        </div>
    {% endif %}


    <script>
        document.getElementById('cancelOrderBtn')?.addEventListener('click', async function () {
            if (confirm("Are you sure you want to cancel this order?")) {
                const csrfToken = document.getElementById('csrf-token').value;
                const orderId = this.dataset.orderId;
                const response = await fetch(`/order/${orderId}/cancel/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken
                    },
                });
                const data = await response.json();
                if (data.status === 'success') {
                    alert('Order cancelled successfully');
                    window.location.reload();
                } else {
                    alert(data.message || 'An error occurred');
                }
            }
        });
        document.getElementById('finishOrderBtn')?.addEventListener('click', async function () {
            if (confirm("Are you sure you want to finish this order?")) {
                const csrfToken = document.getElementById('csrf-token').value;
                const orderId = this.dataset.orderId;
                const response = await fetch(`/order/${orderId}/finish/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken
                    },
                });
                const data = await response.json();
                if (data.status === 'success') {
                    alert('Order finished successfully');
                    window.location.reload();
                } else {
                    alert(data.message || 'An error occurred');
                }
            }
        });
    </script>
{% endblock %}
