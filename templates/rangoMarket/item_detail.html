{% extends "rangoMarket/base.html" %}
{% load static %}

{% block title_block %}
    Item detail for {{ item.title }}
{% endblock %}

{% block body_block %}
    <link rel="stylesheet" href="{% static 'item-detail.css' %}"/>
    {#   <h2>{{ item.title }}</h2>#}
    {#  <p>Seller: {{ item.seller.username }}</p>#}
    {#  <p>Description: {{ item.description }}</p>#}
    {# <p>Price: {{ item.price }}</p>#}

    {#  {% for image in item.images.all %} #}
    {#  <img src="{{ image.image.url }}" alt="{{ item.title }}"> #}
    {# {% empty %} #}
    {# <p>No images available.</p> #}
    {# {% endfor %} #}

    <div class="product-container">
        <div class="container">
            <div class="product-image">
                {% for image in item.images.all %}
                    <img src="{{ image.image.url }}" alt="{{ item.title }}">
                {% empty %}
                    <p>No images available.</p>
                {% endfor %}
            </div>

            <div class="product-details">
                <h1 class="product-name">{{ item.title }}</h1>
                <p class="product-price">Price: {{ item.price }}</p>
                <p class="user-name">Seller: {{ item.seller.username }}</p>
                <p class="product-description">Description: {{ item.description }}</p>
                <p class="product-description">
                <p>Posted on: {{ item.created_at|date:"F j, Y, P" }}</p>

                <p>
                    <!-- Buy button -->
                    {% if user.is_authenticated and item.seller != user %}
                        <button id="buyBtn" class="btn btn-primary" data-item-id="{{ item.id }}">Buy</button>
                        <input type="hidden" id="csrf-token" value="{{ csrf_token }}">
                    {% endif %}
                    <!-- Withdraw button -->
                    {% if item.seller == user and not item.withdrawn %}
                        <button id="withdrawPostBtn" data-item-id="{{ item.id }}" class="btn btn-danger">Withdraw Post
                        </button>
                        <input type="hidden" id="csrf-token" value="{{ csrf_token }}">
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('buyBtn')?.addEventListener('click', async function () {
            if (confirm("Are you sure you want to buy this item?")) {
                const csrfToken = document.getElementById('csrf-token').value;
                const itemId = this.dataset.itemId;
                const response = await fetch(`/item/${itemId}/buy/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken
                    },
                });
                const data = await response.json();
                if (data.status === 'success') {
                    alert('Item purchased successfully');
                    window.location.href = `{% url 'rangoMarket:order_detail' 0 %}`.replace('0', data.order_id);
                } else {
                    alert(data.message || 'An error occurred');
                }
            }
        });
        document.getElementById('withdrawPostBtn')?.addEventListener('click', async function () {
            if (confirm("Are you sure you want to withdraw this post?")) {
                const csrfToken = document.getElementById('csrf-token').value;
                const itemId = this.dataset.itemId;
                const response = await fetch(`/item/${itemId}/withdraw/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken
                    },
                });
                const data = await response.json();
                if (data.status === 'success') {
                    alert('Post withdrawn successfully');
                    window.location.reload();
                } else {
                    alert(data.message || 'An error occurred');
                }
            }
        });
    </script>

{% endblock %}
